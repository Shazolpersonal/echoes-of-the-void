# Implementation Plan

- [x] 1. Project Setup and Configuration
  - [x] 1.1 Initialize Next.js 15 project with TypeScript and App Router
    - Run `npx create-next-app@latest` with TypeScript, Tailwind CSS, App Router options
    - Install dependencies: `zustand`, `zod`, `ai`, `@ai-sdk/google`, `fast-check`
    - _Requirements: 8.1, 8.4_
  - [x] 1.2 Configure environment variables
    - Create `.env.local` with `GOOGLE_GENERATIVE_AI_API_KEY` placeholder
    - Create `.env.example` documenting required variables
    - _Requirements: 8.1_
  - [x] 1.3 Create placeholder audio assets
    - Create `public/sounds/` directory
    - Add placeholder audio files: `wind.mp3`, `scream.mp3`, `drip.mp3`, `combat.mp3`
    - _Requirements: 6.3_

- [-] 2. Define Core Data Models and Schema
  - [x] 2.1 Create Zod schema for AI responses
    - Create `src/lib/schema.ts` with StructuredResponseSchema
    - Define VisualCueEnum, SoundCueEnum, GameStateUpdateSchema
    - Export TypeScript types from schema
    - _Requirements: 8.2, 8.4, 4.3_
  - [ ]* 2.2 Write property test for schema validation
    - **Property 4: Schema validation ensures response structure**
    - **Validates: Requirements 4.3, 8.2**
  - [x] 2.3 Create game state types
    - Create `src/types/game.ts` with GameState, ConversationTurn, NarrativeEntry interfaces
    - _Requirements: 4.1, 4.2, 5.1, 5.2, 5.3_

- [-] 3. Implement Utility Libraries
  - [x] 3.1 Create ASCII art library
    - Create `src/lib/ascii.ts` with ASCII_ART record mapping VisualCue to art strings
    - Implement `getASCIIArt()` and `hasASCIIArt()` functions
    - _Requirements: 7.1_
  - [ ]* 3.2 Write property test for ASCII art mapping
    - **Property 11: Visual cue maps to correct ASCII art**
    - **Validates: Requirements 7.1**
  - [x] 3.3 Create system prompts library
    - Create `src/lib/prompts.ts` with SYSTEM_PROMPT and INITIAL_PROMPT constants
    - Enforce dark 80s horror tone and character rules
    - _Requirements: 4.1, 4.2_
  - [x] 3.4 Create context builder
    - Create `src/lib/context.ts` with `buildContext()` function
    - Include last 5 turns of history and current player state
    - _Requirements: 4.1, 4.2, 4.4_
  - [ ]* 3.5 Write property test for context builder
    - **Property 3: Context includes recent history and player state**
    - **Validates: Requirements 4.1, 4.2**
  - [ ]* 3.6 Write property test for game state serialization round-trip
    - **Property 5: Game state serialization round-trip**
    - **Validates: Requirements 4.4, 4.5**
  - [x] 3.7 Create SoundManager utility
    - Create `src/lib/sound-manager.ts` with preload, play, setVolume functions
    - Map SoundCue enum to audio file paths
    - _Requirements: 6.1, 6.2, 6.3_
  - [ ]* 3.8 Write property test for sound cue mapping
    - **Property 10: Sound cue triggers correct audio**
    - **Validates: Requirements 6.1**

- [x] 4. Checkpoint
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Implement Zustand Game Store
  - [x] 5.1 Create base game store
    - Create `src/store/game-store.ts` with initial state (health: 100, inventory: [], history: [])
    - Implement `addNarrativeEntry`, `setTypingComplete` actions
    - _Requirements: 5.1, 5.2, 5.3, 5.5_
  - [x] 5.2 Implement state update logic
    - Implement `applyStateUpdate()` action for health_change, inventory_add, inventory_remove
    - Clamp health between 0-100
    - Set isGameOver when health <= 0
    - _Requirements: 5.1, 5.2, 5.3, 5.4_
  - [ ]* 5.3 Write property tests for state updates
    - **Property 6: Health updates are applied correctly with bounds**
    - **Property 7: Inventory add includes new item**
    - **Property 8: Inventory remove excludes item**
    - **Property 9: Game over triggers at zero health**
    - **Validates: Requirements 5.1, 5.2, 5.3, 5.4**
  - [x] 5.4 Implement game reset logic
    - Implement `resetGame()` action to restore initial state
    - Clear history, narrativeEntries, reset health/inventory
    - _Requirements: 5.4_
  - [x] 5.5 Implement game initialization
    - Implement `initializeGame()` action for first load
    - Send __START_GAME__ prompt to generate prologue
    - _Requirements: 3.3, 4.1_

- [x] 6. Implement AI Server Action
  - [x] 6.1 Create generateNarrative server action
    - Create `src/app/actions/generate-narrative.ts`
    - Use Vercel AI SDK `generateObject` with Google Gemini 1.5 Flash
    - Pass system prompt and built context
    - _Requirements: 8.1, 8.2, 4.3_
  - [x] 6.2 Implement error handling and fallback
    - Catch AI errors and return fallback narrative response
    - Log errors for debugging
    - _Requirements: 8.3_
  - [x] 6.3 Wire server action to game store
    - Implement `submitCommand()` action in store
    - Call server action, apply state updates, add narrative entries
    - Handle visual_cue and sound_cue responses
    - _Requirements: 3.3, 5.1, 5.2, 5.3, 6.1, 7.1_

- [ ] 7. Checkpoint
  - Ensure all tests pass, ask the user if questions arise.

- [x] 8. Build Retro Terminal UI Components
  - [x] 8.1 Create RetroTerminal container component
    - Create `src/components/RetroTerminal.tsx`
    - Apply CRT effects: scanlines, flicker, curvature, glow via CSS
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [x] 8.2 Create CRT effects CSS
    - Create `src/styles/crt.css` with scanline overlay, flicker animation, curved screen styles
    - Apply phosphor glow text-shadow
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [x] 8.3 Create CommandInput component
    - Create `src/components/CommandInput.tsx`
    - Auto-focus on mount and after submission
    - Clear input after submission, show processing indicator
    - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - [ ]* 8.4 Write property test for command input behavior
    - **Property 1: Command input clears after submission**
    - **Validates: Requirements 2.3**
  - [x] 8.5 Create NarrativeLog component
    - Create `src/components/NarrativeLog.tsx`
    - Render entries with typewriter effect
    - Auto-scroll to bottom, support click-to-skip
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  - [ ]* 8.6 Write property test for narrative log ordering
    - **Property 2: Player commands appear immediately in log**
    - **Validates: Requirements 3.3**
  - [x] 8.7 Create StatusBar component
    - Create `src/components/StatusBar.tsx`
    - Display health bar and inventory list
    - _Requirements: 5.5_
  - [x] 8.8 Create ASCIIRenderer component
    - Create `src/components/ASCIIRenderer.tsx`
    - Render ASCII art with monospace formatting
    - _Requirements: 7.1, 7.3_
  - [x] 8.9 Create GameOverScreen component
    - Create `src/components/GameOverScreen.tsx`
    - Display GAME OVER message and restart prompt
    - Handle keypress to trigger resetGame
    - _Requirements: 5.4_

- [x] 9. Assemble Main Game Page
  - [x] 9.1 Create game page layout
    - Create `src/app/page.tsx` with RetroTerminal wrapper
    - Compose StatusBar, NarrativeLog, CommandInput components
    - _Requirements: 1.1, 2.1, 3.1, 5.5_
  - [x] 9.2 Wire game initialization on mount
    - Call `initializeGame()` in useEffect on page load
    - Display loading state while generating prologue
    - _Requirements: 3.3, 4.1_
  - [x] 9.3 Handle game over state
    - Conditionally render GameOverScreen when isGameOver is true
    - Disable CommandInput during game over
    - _Requirements: 5.4_

- [x] 10. Polish and Integration
  - [x] 10.1 Integrate SoundManager with game flow
    - Preload sounds on page mount
    - Trigger sounds based on sound_cue responses
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 10.2 Add typewriter animation utility
    - Create `src/lib/typewriter.ts` with character-by-character reveal logic
    - Support skip functionality
    - _Requirements: 3.1, 3.4_
  - [x] 10.3 Final styling polish
    - Adjust CRT effect intensity
    - Fine-tune color scheme (green/amber options)
    - Ensure responsive layout
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 11. Final Checkpoint
  - Ensure all tests pass, ask the user if questions arise.
